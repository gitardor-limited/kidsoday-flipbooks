<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storybook Reader | Kids O'Day</title>
  
  <!-- Google Authentication -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <!-- Turn.js Dependencies -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --bg: #1e293b;
      --card: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: white;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: rgba(30, 41, 59, 0.95);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
      font-weight: bold;
      color: white;
    }

    .logo-icon {
      font-size: 2rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-email {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .logout-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: var(--primary-dark);
    }

    /* Login Screen */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem;
    }

    .login-card {
      background: white;
      padding: 3rem;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    .login-card h1 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 2rem;
    }

    .login-card p {
      color: var(--text-light);
      margin-bottom: 2rem;
    }

    #status {
      color: var(--text-light);
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    /* Flipbook Container */
    .flipbook-container {
      display: none;
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .book-title {
      text-align: center;
      margin-bottom: 2rem;
    }

    .book-title h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .book-title p {
      color: #94a3b8;
      font-size: 1.1rem;
    }

    /* Flipbook */
    .flipbook-wrapper {
      perspective: 2000px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 600px;
    }

    #flipbook {
      width: 900px;
      height: 600px;
      margin: 0 auto;
    }

    #flipbook .page {
      width: 450px;
      height: 600px;
      background: white;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      overflow: hidden;
    }

    #flipbook .page img {
      max-width: 100%;
      max-height: 400px;
      object-fit: contain;
      margin-bottom: 1rem;
    }

    #flipbook .page h2 {
      color: var(--primary);
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }

    #flipbook .page p {
      color: var(--text);
      font-size: 1.1rem;
      line-height: 1.6;
      max-width: 90%;
    }

    #flipbook .cover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      justify-content: center;
    }

    #flipbook .cover h1 {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    #flipbook .cover p {
      font-size: 1.5rem;
      color: rgba(255,255,255,0.9);
    }

    #flipbook .back-cover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      color: white;
    }

    /* Controls */
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      margin-top: 2rem;
    }

    .control-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .control-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .control-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }

    .page-indicator {
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* Loading Spinner */
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      #flipbook {
        width: 700px;
        height: 500px;
      }

      #flipbook .page {
        width: 350px;
        height: 500px;
        padding: 1.5rem;
      }
    }

    @media (max-width: 768px) {
      #flipbook {
        width: 500px;
        height: 400px;
      }

      #flipbook .page {
        width: 250px;
        height: 400px;
        padding: 1rem;
      }

      #flipbook .page h2 {
        font-size: 1.3rem;
      }

      #flipbook .page p {
        font-size: 0.9rem;
      }

      #flipbook .cover h1 {
        font-size: 2rem;
      }

      .controls {
        gap: 1rem;
      }

      .control-btn {
        padding: 0.75rem 1.5rem;
        font-size: 0.9rem;
      }
    }

    @media (max-width: 540px) {
      #flipbook {
        width: 90vw;
        height: 60vh;
      }

      #flipbook .page {
        width: 45vw;
        height: 60vh;
        padding: 0.75rem;
      }

      #flipbook .page img {
        max-height: 200px;
      }

      .book-title h1 {
        font-size: 1.8rem;
      }
    }

    /* Access Denied */
    .access-denied {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem;
    }

    .access-denied-card {
      background: white;
      padding: 3rem;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 500px;
    }

    .access-denied-card h1 {
      color: #ef4444;
      margin-bottom: 1rem;
      font-size: 2rem;
    }

    .access-denied-card p {
      color: var(--text-light);
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .access-denied-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header" id="header" style="display:none;">
    <div class="logo">
      <span class="logo-icon">ðŸŽ“</span>
      <span>Kids O'Day</span>
    </div>
    <div class="user-info">
      <span class="user-email" id="userEmail"></span>
      <button class="logout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <h1>ðŸ“š Storybook Reader</h1>
      <p>Sign in to access your magical stories</p>
      <div id="login"></div>
      <div id="status">Please sign in to continue</div>
    </div>
  </div>

  <!-- Access Denied Screen -->
  <div class="access-denied" id="accessDenied">
    <div class="access-denied-card">
      <div class="access-denied-icon">ðŸ”’</div>
      <h1>Access Denied</h1>
      <p>Sorry, you don't have access to this storybook. Please make sure you're enrolled in this course or contact support.</p>
      <button class="logout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- Flipbook Container -->
  <div class="flipbook-container" id="flipbookContainer">
    <div class="book-title">
      <h1 id="bookTitle">The Rainbow Dragon</h1>
      <p id="bookAuthor">A Magical Adventure Story</p>
    </div>

    <div class="flipbook-wrapper">
      <div id="flipbook">
        <!-- Pages will be loaded here by JavaScript -->
      </div>
    </div>

    <div class="controls">
      <button class="control-btn" id="prevBtn" onclick="previousPage()">
        â—€ Previous
      </button>
      <div class="page-indicator">
        Page <span id="currentPage">1</span> of <span id="totalPages">10</span>
      </div>
      <button class="control-btn" id="nextBtn" onclick="nextPage()">
        Next â–¶
      </button>
    </div>
  </div>

  <script>
    const CLIENT_ID = "656751987892-s5h4b3h7aq6rl63ut7pl6hgm3d2vr46p.apps.googleusercontent.com";
    const API_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE"; // Replace with your deployed script URL
    const SESSION_DAYS = 30;

    // Get book ID from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get('book') || 'rainbow-dragon';

    let currentUser = null;
    let flipbookInitialized = false;

    // Sample book data (in production, this would come from your backend)
    const books = {
      'rainbow-dragon': {
        title: 'The Rainbow Dragon',
        author: 'A Magical Adventure Story',
        pages: [
          {
            type: 'cover',
            title: 'The Rainbow Dragon',
            subtitle: 'By Kids O\'Day'
          },
          {
            image: 'https://images.unsplash.com/photo-1518173946687-a4c8892bbd9f?w=400&h=300&fit=crop',
            title: 'Chapter 1: A Colorful Discovery',
            text: 'Luna found a mysterious egg in her garden. It shimmered with all the colors of the rainbow.'
          },
          {
            image: 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=400&h=300&fit=crop',
            title: 'Chapter 2: The Hatching',
            text: 'One morning, the egg began to crack. Out came a tiny dragon with rainbow scales!'
          },
          {
            image: 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?w=400&h=300&fit=crop',
            title: 'Chapter 3: Learning to Fly',
            text: 'Luna named him Rainbow. Together, they practiced flying through the clouds.'
          },
          {
            image: 'https://images.unsplash.com/photo-1501594907352-04cda38ebc29?w=400&h=300&fit=crop',
            title: 'Chapter 4: The Color Magic',
            text: 'Rainbow taught Luna that each color has its own special magic and meaning.'
          },
          {
            image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop',
            title: 'Chapter 5: The Adventure',
            text: 'They soared over mountains and seas, spreading colorful joy wherever they went.'
          },
          {
            image: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&h=300&fit=crop',
            title: 'Chapter 6: The Lesson',
            text: 'Rainbow showed Luna that being different makes the world more beautiful.'
          },
          {
            image: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=400&h=300&fit=crop',
            title: 'Chapter 7: Forever Friends',
            text: 'Luna and Rainbow became the best of friends, proving that friendship knows no bounds.'
          },
          {
            image: 'https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?w=400&h=300&fit=crop',
            title: 'The End',
            text: 'And they lived happily ever after, sharing their colorful adventures with everyone.'
          },
          {
            type: 'back-cover',
            title: 'The End',
            subtitle: 'Thank you for reading! ðŸŒˆâœ¨'
          }
        ]
      }
    };

    /* ================= SESSION MANAGEMENT ================= */
    function saveSession(email, firstName, lastName) {
      localStorage.setItem("kidsoday_flipbook_email", email);
      localStorage.setItem("kidsoday_flipbook_firstName", firstName || "");
      localStorage.setItem("kidsoday_flipbook_lastName", lastName || "");
      localStorage.setItem("kidsoday_flipbook_until", Date.now() + SESSION_DAYS * 86400000);
    }

    function getSession() {
      const e = localStorage.getItem("kidsoday_flipbook_email");
      const u = localStorage.getItem("kidsoday_flipbook_until");
      if (e && u && Date.now() < +u) {
        return {
          email: e,
          firstName: localStorage.getItem("kidsoday_flipbook_firstName") || "",
          lastName: localStorage.getItem("kidsoday_flipbook_lastName") || ""
        };
      }
      return null;
    }

    function signOut() {
      localStorage.clear();
      location.reload();
    }

    /* ================= ACCESS VERIFICATION ================= */
    function verifyAccess(email) {
      // In production, check against your Google Sheets Database
      // For now, we'll allow access for demonstration
      // You can integrate with your existing API_URL
      
      const url = `${API_URL}?action=checkFlipbookAccess&email=${encodeURIComponent(email)}&bookId=${encodeURIComponent(bookId)}`;
      
      return fetch(url)
        .then(r => r.json())
        .then(data => {
          return data.hasAccess === true;
        })
        .catch(err => {
          console.error("Access verification error:", err);
          // For demo purposes, allow access if API fails
          // In production, you should deny access on error
          return true;
        });
    }

    /* ================= FLIPBOOK INITIALIZATION ================= */
    function initializeFlipbook() {
      if (flipbookInitialized) return;

      const book = books[bookId];
      if (!book) {
        alert('Book not found!');
        return;
      }

      // Update book info
      document.getElementById('bookTitle').textContent = book.title;
      document.getElementById('bookAuthor').textContent = book.author;
      document.getElementById('totalPages').textContent = book.pages.length;

      // Create pages
      const flipbook = $('#flipbook');
      flipbook.empty();

      book.pages.forEach((page, index) => {
        let pageContent = '';
        
        if (page.type === 'cover') {
          pageContent = `
            <div class="page cover">
              <h1>${page.title}</h1>
              <p>${page.subtitle}</p>
            </div>
          `;
        } else if (page.type === 'back-cover') {
          pageContent = `
            <div class="page back-cover">
              <h1>${page.title}</h1>
              <p>${page.subtitle}</p>
            </div>
          `;
        } else {
          pageContent = `
            <div class="page">
              ${page.image ? `<img src="${page.image}" alt="${page.title}">` : ''}
              <h2>${page.title}</h2>
              <p>${page.text}</p>
            </div>
          `;
        }

        flipbook.append(pageContent);
      });

      // Initialize Turn.js
      flipbook.turn({
        width: 900,
        height: 600,
        autoCenter: true,
        duration: 1000,
        gradients: true,
        acceleration: true,
        elevation: 50
      });

      // Update page indicator on turn
      flipbook.bind('turned', function(event, page, view) {
        updatePageIndicator(page);
      });

      flipbookInitialized = true;
      updatePageIndicator(1);
    }

    /* ================= PAGE NAVIGATION ================= */
    function nextPage() {
      $('#flipbook').turn('next');
    }

    function previousPage() {
      $('#flipbook').turn('previous');
    }

    function updatePageIndicator(page) {
      document.getElementById('currentPage').textContent = page;
      
      // Update button states
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const totalPages = books[bookId].pages.length;
      
      prevBtn.disabled = page === 1;
      nextBtn.disabled = page === totalPages;
    }

    /* ================= GOOGLE SIGN-IN ================= */
    function onGoogle(res) {
      const payload = JSON.parse(atob(res.credential.split(".")[1]));
      const email = payload.email;
      const firstName = payload.given_name || "";
      const lastName = payload.family_name || "";

      currentUser = { email, firstName, lastName };
      saveSession(email, firstName, lastName);

      document.getElementById('status').textContent = 'Verifying access...';

      verifyAccess(email).then(hasAccess => {
        if (hasAccess) {
          showFlipbook(email);
        } else {
          showAccessDenied();
        }
      });
    }

    function showFlipbook(email) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('accessDenied').style.display = 'none';
      document.getElementById('header').style.display = 'flex';
      document.getElementById('flipbookContainer').style.display = 'block';
      document.getElementById('userEmail').textContent = email;

      // Initialize flipbook after DOM is visible
      setTimeout(() => {
        initializeFlipbook();
      }, 100);
    }

    function showAccessDenied() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('accessDenied').style.display = 'flex';
    }

    function initializeGoogleSignIn() {
      const sessionData = getSession();

      if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          callback: onGoogle
        });

        if (sessionData) {
          currentUser = sessionData;
          document.getElementById('status').textContent = 'Verifying access...';
          
          verifyAccess(sessionData.email).then(hasAccess => {
            if (hasAccess) {
              showFlipbook(sessionData.email);
            } else {
              showAccessDenied();
            }
          });
        } else {
          document.getElementById('status').textContent = 'Sign in to continue';
          google.accounts.id.renderButton(
            document.getElementById("login"),
            { theme: "outline", size: "large" }
          );
        }
      } else {
        setTimeout(initializeGoogleSignIn, 100);
      }
    }

    // Initialize on load
    window.onload = initializeGoogleSignIn;

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (!flipbookInitialized) return;
      
      if (e.key === 'ArrowRight' || e.key === 'PageDown') {
        nextPage();
      } else if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
        previousPage();
      }
    });
  </script>
</body>
</html>
