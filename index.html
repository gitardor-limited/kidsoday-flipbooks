<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storybook Reader | Kids O'Day</title>
  
  <!-- Google Authentication -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <!-- Turn.js Dependencies -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --bg: #1e293b;
      --card: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: white;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: rgba(30, 41, 59, 0.95);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
      font-weight: bold;
      color: white;
    }

    .logo-icon {
      font-size: 2rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-email {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .logout-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: var(--primary-dark);
    }

    /* Login Screen */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem;
    }

    .login-card {
      background: white;
      padding: 3rem;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    .login-card h1 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 2rem;
    }

    .login-card p {
      color: var(--text-light);
      margin-bottom: 2rem;
    }

    #status {
      color: var(--text-light);
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    /* Flipbook Container */
    .flipbook-container {
      display: none;
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .book-title {
      text-align: center;
      margin-bottom: 2rem;
    }

    .book-title h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .book-title p {
      color: #94a3b8;
      font-size: 1.1rem;
    }

    /* Flipbook */
    .flipbook-wrapper {
      perspective: 2000px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 600px;
    }

    #flipbook {
      width: 900px;
      height: 600px;
      margin: 0 auto;
    }

    #flipbook .page {
      width: 450px;
      height: 600px;
      background: white;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      overflow: hidden;
    }

    #flipbook .page img {
      max-width: 100%;
      max-height: 400px;
      object-fit: contain;
      margin-bottom: 1rem;
    }

    #flipbook .page h2 {
      color: var(--primary);
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }

    #flipbook .page p {
      color: var(--text);
      font-size: 1.1rem;
      line-height: 1.6;
      max-width: 90%;
    }

    #flipbook .cover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      justify-content: center;
    }

    #flipbook .cover h1 {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    #flipbook .cover p {
      font-size: 1.5rem;
      color: rgba(255,255,255,0.9);
    }

    #flipbook .back-cover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      color: white;
    }

    /* Controls */
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      margin-top: 2rem;
    }

    .control-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .control-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .control-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
    }

    .page-indicator {
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* Loading Spinner */
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Page Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }

    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      10%, 30% { transform: scale(0.9); }
      20%, 40% { transform: scale(1.1); }
    }

    .animate-fadeIn { animation: fadeIn 1s ease-in; }
    .animate-slideInRight { animation: slideInRight 0.8s ease-out; }
    .animate-bounce { animation: bounce 2s infinite; }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-float { animation: float 3s ease-in-out infinite; }
    .animate-zoomIn { animation: zoomIn 0.8s ease-out; }
    .animate-heartBeat { animation: heartBeat 1.5s infinite; }

    /* Interactive Elements */
    .tap-reveal {
      background: var(--primary);
      color: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 1rem;
      font-size: 1rem;
      font-weight: 600;
      border: 3px dashed rgba(255,255,255,0.5);
    }

    .tap-reveal:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .tap-reveal.revealed {
      background: var(--success);
      border-style: solid;
      animation: heartBeat 1s;
    }

    /* Audio Player */
    .audio-controls {
      margin-top: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    .audio-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .audio-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }

    .audio-btn.playing {
      background: var(--success);
      animation: pulse 1.5s infinite;
    }

    /* Progress Bar */
    .progress-container {
      position: fixed;
      top: 60px;
      left: 0;
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      z-index: 99;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      transition: width 0.3s;
      box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
    }

    /* Bookmark */
    .bookmark-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      transition: all 0.3s;
      opacity: 0.6;
    }

    .bookmark-btn:hover {
      opacity: 1;
      transform: scale(1.2);
    }

    .bookmark-btn.bookmarked {
      opacity: 1;
      animation: bounce 0.5s;
    }

    /* Reading Stats */
    .reading-stats {
      text-align: center;
      padding: 1rem;
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .reading-stats strong {
      color: white;
    }

    /* Quiz Modal */
    .quiz-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .quiz-modal.active {
      display: flex;
    }

    .quiz-content {
      background: white;
      border-radius: 16px;
      padding: 3rem;
      max-width: 600px;
      width: 100%;
      color: var(--text);
    }

    .quiz-content h2 {
      color: var(--primary);
      margin-bottom: 2rem;
      text-align: center;
    }

    .quiz-question {
      margin-bottom: 2rem;
    }

    .quiz-question h3 {
      margin-bottom: 1rem;
      color: var(--text);
    }

    .quiz-option {
      background: var(--bg);
      color: white;
      padding: 1rem;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .quiz-option:hover {
      background: var(--primary);
      transform: translateX(10px);
    }

    .quiz-option.selected {
      background: var(--primary);
    }

    .quiz-option.correct {
      background: var(--success);
    }

    .quiz-option.incorrect {
      background: var(--danger);
    }

    .quiz-submit {
      background: var(--primary);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      margin-top: 1rem;
      transition: all 0.3s;
    }

    .quiz-submit:hover {
      background: var(--primary-dark);
    }

    .quiz-result {
      text-align: center;
      padding: 2rem;
      margin-top: 2rem;
      background: var(--bg);
      border-radius: 12px;
      color: white;
    }

    .quiz-score {
      font-size: 3rem;
      font-weight: bold;
      color: var(--success);
      margin: 1rem 0;
    }

    /* Certificate Modal */
    .certificate-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .certificate-modal.active {
      display: flex;
    }

    .certificate {
      background: white;
      padding: 3rem;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      text-align: center;
      border: 10px solid var(--primary);
      position: relative;
    }

    .certificate-header {
      color: var(--primary);
      font-size: 2.5rem;
      margin-bottom: 1rem;
      font-weight: bold;
    }

    .certificate-title {
      font-size: 1.5rem;
      color: var(--text);
      margin-bottom: 2rem;
    }

    .certificate-name {
      font-size: 2rem;
      color: var(--primary);
      font-weight: bold;
      margin: 2rem 0;
      text-decoration: underline;
      text-decoration-style: double;
    }

    .certificate-text {
      color: var(--text);
      line-height: 1.8;
      margin-bottom: 2rem;
    }

    .certificate-badge {
      font-size: 4rem;
      margin: 2rem 0;
    }

    .certificate-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }

    .cert-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
    }

    .cert-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      #flipbook {
        width: 700px;
        height: 500px;
      }

      #flipbook .page {
        width: 350px;
        height: 500px;
        padding: 1.5rem;
      }
    }

    @media (max-width: 768px) {
      #flipbook {
        width: 500px;
        height: 400px;
      }

      #flipbook .page {
        width: 250px;
        height: 400px;
        padding: 1rem;
      }

      #flipbook .page h2 {
        font-size: 1.3rem;
      }

      #flipbook .page p {
        font-size: 0.9rem;
      }

      #flipbook .cover h1 {
        font-size: 2rem;
      }

      .controls {
        gap: 1rem;
      }

      .control-btn {
        padding: 0.75rem 1.5rem;
        font-size: 0.9rem;
      }
    }

    @media (max-width: 540px) {
      #flipbook {
        width: 90vw;
        height: 60vh;
      }

      #flipbook .page {
        width: 45vw;
        height: 60vh;
        padding: 0.75rem;
      }

      #flipbook .page img {
        max-height: 200px;
      }

      .book-title h1 {
        font-size: 1.8rem;
      }
    }

    /* Access Denied */
    .access-denied {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem;
    }

    .access-denied-card {
      background: white;
      padding: 3rem;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 500px;
    }

    .access-denied-card h1 {
      color: #ef4444;
      margin-bottom: 1rem;
      font-size: 2rem;
    }

    .access-denied-card p {
      color: var(--text-light);
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .access-denied-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header" id="header" style="display:none;">
    <div class="logo">
      <span class="logo-icon">üéì</span>
      <span>Kids O'Day</span>
    </div>
    <div class="user-info">
      <span class="user-email" id="userEmail"></span>
      <button class="logout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <h1>üìö Storybook Reader</h1>
      <p>Sign in to access your magical stories</p>
      <div id="login"></div>
      <div id="status">Please sign in to continue</div>
    </div>
  </div>

  <!-- Access Denied Screen -->
  <div class="access-denied" id="accessDenied">
    <div class="access-denied-card">
      <div class="access-denied-icon">üîí</div>
      <h1>Access Denied</h1>
      <p>Sorry, you don't have access to this storybook. Please make sure you're enrolled in this course or contact support.</p>
      <button class="logout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- Flipbook Container -->
  <div class="flipbook-container" id="flipbookContainer">
    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>

    <div class="book-title">
      <h1 id="bookTitle">The Rainbow Dragon</h1>
      <p id="bookAuthor">A Magical Adventure Story</p>
    </div>

    <!-- Reading Stats -->
    <div class="reading-stats">
      <span>üìñ Estimated reading time: <strong id="readingTime">15 minutes</strong></span>
      <span style="margin-left: 2rem;">‚è±Ô∏è Time spent: <strong id="timeSpent">0:00</strong></span>
    </div>

    <div class="flipbook-wrapper">
      <div id="flipbook">
        <!-- Pages will be loaded here by JavaScript -->
      </div>
    </div>

    <div class="controls">
      <button class="control-btn" id="prevBtn" onclick="previousPage()">
        ‚óÄ Previous
      </button>
      <div class="page-indicator">
        Page <span id="currentPage">1</span> of <span id="totalPages">10</span>
      </div>
      <button class="control-btn" id="nextBtn" onclick="nextPage()">
        Next ‚ñ∂
      </button>
    </div>
  </div>

  <!-- Quiz Modal -->
  <div class="quiz-modal" id="quizModal">
    <div class="quiz-content">
      <h2>üìù Story Quiz</h2>
      <div id="quizQuestions"></div>
      <button class="quiz-submit" id="submitQuiz" onclick="submitQuiz()">Submit Quiz</button>
      <div id="quizResult" style="display:none;"></div>
    </div>
  </div>

  <!-- Certificate Modal -->
  <div class="certificate-modal" id="certificateModal">
    <div class="certificate">
      <div class="certificate-header">üèÜ Certificate of Completion üèÜ</div>
      <div class="certificate-title">This certifies that</div>
      <div class="certificate-name" id="certificateName">Student Name</div>
      <div class="certificate-text">
        has successfully completed reading<br>
        <strong id="certificateBook">The Rainbow Dragon</strong><br>
        and passed the comprehension quiz with flying colors!
      </div>
      <div class="certificate-badge">üåü‚ú®üéâ</div>
      <div style="color: var(--text-light); font-size: 0.9rem;">
        Date: <span id="certificateDate"></span>
      </div>
      <div class="certificate-actions">
        <button class="cert-btn" onclick="downloadCertificate()">üì• Download</button>
        <button class="cert-btn" onclick="closeCertificate()">Close</button>
      </div>
    </div>
  </div>

  <script>
    const CLIENT_ID = "656751987892-s5h4b3h7aq6rl63ut7pl6hgm3d2vr46p.apps.googleusercontent.com";
    const API_URL = "YOUR_GOOGLE_APPS_SCRIPT_URL_HERE"; // Replace with your deployed script URL
    const SESSION_DAYS = 30;

    // Get book ID from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get('book') || 'rainbow-dragon';

    let currentUser = null;
    let flipbookInitialized = false;
    let currentAudio = null;
    let startTime = null;
    let readingTimer = null;
    let bookmarks = [];
    let userAnswers = [];

    // Sample book data (in production, this would come from your backend)
    const books = {
      'rainbow-dragon': {
        title: 'The Rainbow Dragon',
        author: 'A Magical Adventure Story',
        estimatedReadTime: 15, // minutes
        quiz: {
          questions: [
            {
              question: "What did Luna find in her garden?",
              options: ["A flower", "A mysterious egg", "A treasure", "A book"],
              correct: 1
            },
            {
              question: "What was special about the dragon?",
              options: ["It was invisible", "It had rainbow scales", "It could talk", "It was tiny"],
              correct: 1
            },
            {
              question: "What did Rainbow teach Luna?",
              options: ["How to fly", "Each color has special magic", "How to draw", "Math skills"],
              correct: 1
            }
          ]
        },
        pages: [
          {
            type: 'cover',
            title: 'The Rainbow Dragon',
            subtitle: 'By Kids O\'Day',
            audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' // Sample audio
          },
          {
            image: 'https://images.unsplash.com/photo-1518173946687-a4c8892bbd9f?w=400&h=300&fit=crop',
            title: 'Chapter 1: A Colorful Discovery',
            text: 'Luna found a mysterious egg in her garden. It shimmered with all the colors of the rainbow.',
            audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
            animations: ['fadeIn', 'bounce'],
            interactive: {
              type: 'tap-reveal',
              hidden: 'ü•ö Tap the egg to see it shimmer!',
              revealed: '‚ú® The egg glows with rainbow colors! ‚ú®'
            }
          },
          {
            image: 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=400&h=300&fit=crop',
            title: 'Chapter 2: The Hatching',
            text: 'One morning, the egg began to crack. Out came a tiny dragon with rainbow scales!',
            audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
            animations: ['slideInRight'],
            interactive: {
              type: 'tap-reveal',
              hidden: 'ü•ö Tap to see the dragon hatch!',
              revealed: 'üêâ A beautiful rainbow dragon appears!'
            }
          },
          {
            image: 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?w=400&h=300&fit=crop',
            title: 'Chapter 3: Learning to Fly',
            text: 'Luna named him Rainbow. Together, they practiced flying through the clouds.',
            audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3',
            animations: ['float']
          },
          {
            image: 'https://images.unsplash.com/photo-1501594907352-04cda38ebc29?w=400&h=300&fit=crop',
            title: 'Chapter 4: The Color Magic',
            text: 'Rainbow taught Luna that each color has its own special magic and meaning.',
            audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3',
            animations: ['pulse'],
            interactive: {
              type: 'tap-reveal',
              hidden: 'üåà Tap to discover the color magic!',
              revealed: '‚ú® Red=Love, Blue=Peace, Yellow=Joy! ‚ú®'
            }
          },
          {
            image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop',
            title: 'Chapter 5: The Adventure',
            text: 'They soared over mountains and seas, spreading colorful joy wherever they went.',
            audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3',
            animations: ['zoomIn']
          },
          {
            image: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&h=300&fit=crop',
            title: 'Chapter 6: The Lesson',
            text: 'Rainbow showed Luna that being different makes the world more beautiful.',
            audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3',
            animations: ['fadeIn']
          },
          {
            image: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=400&h=300&fit=crop',
            title: 'Chapter 7: Forever Friends',
            text: 'Luna and Rainbow became the best of friends, proving that friendship knows no bounds.',
            audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3',
            animations: ['heartBeat']
          },
          {
            image: 'https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?w=400&h=300&fit=crop',
            title: 'The End',
            text: 'And they lived happily ever after, sharing their colorful adventures with everyone.',
            audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3',
            animations: ['fadeIn']
          },
          {
            type: 'back-cover',
            title: 'The End',
            subtitle: 'Thank you for reading! üåà‚ú®'
          }
        ]
      }
    };

    /* ================= SESSION MANAGEMENT ================= */
    function saveSession(email, firstName, lastName) {
      localStorage.setItem("kidsoday_flipbook_email", email);
      localStorage.setItem("kidsoday_flipbook_firstName", firstName || "");
      localStorage.setItem("kidsoday_flipbook_lastName", lastName || "");
      localStorage.setItem("kidsoday_flipbook_until", Date.now() + SESSION_DAYS * 86400000);
    }

    function getSession() {
      const e = localStorage.getItem("kidsoday_flipbook_email");
      const u = localStorage.getItem("kidsoday_flipbook_until");
      if (e && u && Date.now() < +u) {
        return {
          email: e,
          firstName: localStorage.getItem("kidsoday_flipbook_firstName") || "",
          lastName: localStorage.getItem("kidsoday_flipbook_lastName") || ""
        };
      }
      return null;
    }

    function signOut() {
      localStorage.clear();
      location.reload();
    }

    /* ================= ACCESS VERIFICATION ================= */
    function verifyAccess(email) {
      // In production, check against your Google Sheets Database
      // For now, we'll allow access for demonstration
      // You can integrate with your existing API_URL
      
      const url = `${API_URL}?action=checkFlipbookAccess&email=${encodeURIComponent(email)}&bookId=${encodeURIComponent(bookId)}`;
      
      return fetch(url)
        .then(r => r.json())
        .then(data => {
          return data.hasAccess === true;
        })
        .catch(err => {
          console.error("Access verification error:", err);
          // For demo purposes, allow access if API fails
          // In production, you should deny access on error
          return true;
        });
    }

    /* ================= FLIPBOOK INITIALIZATION ================= */
    function initializeFlipbook() {
      if (flipbookInitialized) return;

      const book = books[bookId];
      if (!book) {
        alert('Book not found!');
        return;
      }

      // Update book info
      document.getElementById('bookTitle').textContent = book.title;
      document.getElementById('bookAuthor').textContent = book.author;
      document.getElementById('totalPages').textContent = book.pages.length;

      // Create pages
      const flipbook = $('#flipbook');
      flipbook.empty();

      book.pages.forEach((page, index) => {
        let pageContent = '';
        
        if (page.type === 'cover') {
          pageContent = `
            <div class="page cover">
              <h1>${page.title}</h1>
              <p>${page.subtitle}</p>
            </div>
          `;
        } else if (page.type === 'back-cover') {
          pageContent = `
            <div class="page back-cover">
              <h1>${page.title}</h1>
              <p>${page.subtitle}</p>
            </div>
          `;
        } else {
          pageContent = `
            <div class="page">
              ${page.image ? `<img src="${page.image}" alt="${page.title}">` : ''}
              <h2>${page.title}</h2>
              <p>${page.text}</p>
            </div>
          `;
        }

        flipbook.append(pageContent);
      });

      // Initialize Turn.js
      flipbook.turn({
        width: 900,
        height: 600,
        autoCenter: true,
        duration: 1000,
        gradients: true,
        acceleration: true,
        elevation: 50
      });

      // Update page indicator on turn
      flipbook.bind('turned', function(event, page, view) {
        updatePageIndicator(page);
      });

      flipbookInitialized = true;
      updatePageIndicator(1);
    }

    /* ================= PAGE NAVIGATION ================= */
    function nextPage() {
      $('#flipbook').turn('next');
    }

    function previousPage() {
      $('#flipbook').turn('previous');
    }

    function updatePageIndicator(page) {
      document.getElementById('currentPage').textContent = page;
      
      // Update button states
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const totalPages = books[bookId].pages.length;
      
      prevBtn.disabled = page === 1;
      nextBtn.disabled = page === totalPages;
    }

    /* ================= GOOGLE SIGN-IN ================= */
    function onGoogle(res) {
      const payload = JSON.parse(atob(res.credential.split(".")[1]));
      const email = payload.email;
      const firstName = payload.given_name || "";
      const lastName = payload.family_name || "";

      currentUser = { email, firstName, lastName };
      saveSession(email, firstName, lastName);

      document.getElementById('status').textContent = 'Verifying access...';

      verifyAccess(email).then(hasAccess => {
        if (hasAccess) {
          showFlipbook(email);
        } else {
          showAccessDenied();
        }
      });
    }

    function showFlipbook(email) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('accessDenied').style.display = 'none';
      document.getElementById('header').style.display = 'flex';
      document.getElementById('flipbookContainer').style.display = 'block';
      document.getElementById('userEmail').textContent = email;

      // Initialize flipbook after DOM is visible
      setTimeout(() => {
        initializeFlipbook();
      }, 100);
    }

    function showAccessDenied() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('accessDenied').style.display = 'flex';
    }

    function initializeGoogleSignIn() {
      const sessionData = getSession();

      if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.initialize({
          client_id: CLIENT_ID,
          callback: onGoogle
        });

        if (sessionData) {
          currentUser = sessionData;
          document.getElementById('status').textContent = 'Verifying access...';
          
          verifyAccess(sessionData.email).then(hasAccess => {
            if (hasAccess) {
              showFlipbook(sessionData.email);
            } else {
              showAccessDenied();
            }
          });
        } else {
          document.getElementById('status').textContent = 'Sign in to continue';
          google.accounts.id.renderButton(
            document.getElementById("login"),
            { theme: "outline", size: "large" }
          );
        }
      } else {
        setTimeout(initializeGoogleSignIn, 100);
      }
    }

    // Initialize on load
    window.onload = initializeGoogleSignIn;

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (!flipbookInitialized) return;
      
      if (e.key === 'ArrowRight' || e.key === 'PageDown') {
        nextPage();
      } else if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
        previousPage();
      }
    });

    /* ================= ENHANCED FEATURES ================= */
    
    // Audio Narration
    function playAudio(audioUrl) {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      
      if (audioUrl) {
        currentAudio = new Audio(audioUrl);
        currentAudio.play();
      }
    }

    function stopAudio() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
    }

    //Progress Tracking
    function updateProgress(page) {
      const book = books[bookId];
      const progress = (page / book.pages.length) * 100;
      document.getElementById('progressBar').style.width = progress + '%';
      
      // Check if reached end
      if (page === book.pages.length && !book.quizCompleted) {
        // Show quiz after finishing the book
        setTimeout(() => {
          showQuiz();
        }, 1000);
      }
    }

    // Reading Time Tracker
    function startReadingTimer() {
      startTime = Date.now();
      readingTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('timeSpent').textContent = 
          `${minutes}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    function stopReadingTimer() {
      if (readingTimer) {
        clearInterval(readingTimer);
      }
    }

    // Bookmarks
    function toggleBookmark(page) {
      const index = bookmarks.indexOf(page);
      if (index > -1) {
        bookmarks.splice(index, 1);
      } else {
        bookmarks.push(page);
      }
      saveBookmarks();
    }

    function saveBookmarks() {
      localStorage.setItem(`bookmarks_${bookId}`, JSON.stringify(bookmarks));
    }

    function loadBookmarks() {
      const saved = localStorage.getItem(`bookmarks_${bookId}`);
      if (saved) {
        bookmarks = JSON.parse(saved);
      }
    }

    // Quiz System
    function showQuiz() {
      const book = books[bookId];
      if (!book.quiz) return;
      
      const quizContainer = document.getElementById('quizQuestions');
      quizContainer.innerHTML = '';
      userAnswers = [];
      
      book.quiz.questions.forEach((q, qIndex) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'quiz-question';
        questionDiv.innerHTML = `
          <h3>${qIndex + 1}. ${q.question}</h3>
          ${q.options.map((option, oIndex) => `
            <div class="quiz-option" data-question="${qIndex}" data-option="${oIndex}">
              ${option}
            </div>
          `).join('')}
        `;
        quizContainer.appendChild(questionDiv);
      });
      
      // Add click handlers
      document.querySelectorAll('.quiz-option').forEach(option => {
        option.addEventListener('click', function() {
          const question = parseInt(this.dataset.question);
          const optionIndex = parseInt(this.dataset.option);
          
          // Remove previous selection
          document.querySelectorAll(`[data-question="${question}"]`).forEach(opt => {
            opt.classList.remove('selected');
          });
          
          // Mark as selected
          this.classList.add('selected');
          userAnswers[question] = optionIndex;
        });
      });
      
      document.getElementById('quizModal').classList.add('active');
      document.getElementById('quizResult').style.display = 'none';
    }

    function submitQuiz() {
      const book = books[bookId];
      if (!book.quiz) return;
      
      let correct = 0;
      book.quiz.questions.forEach((q, index) => {
        if (userAnswers[index] === q.correct) {
          correct++;
          document.querySelectorAll(`[data-question="${index}"]`)[userAnswers[index]].classList.add('correct');
        } else {
          if (userAnswers[index] !== undefined) {
            document.querySelectorAll(`[data-question="${index}"]`)[userAnswers[index]].classList.add('incorrect');
          }
          document.querySelectorAll(`[data-question="${index}"]`)[q.correct].classList.add('correct');
        }
      });
      
      const percentage = Math.round((correct / book.quiz.questions.length) * 100);
      const passed = percentage >= 70;
      
      const resultDiv = document.getElementById('quizResult');
      resultDiv.innerHTML = `
        <div class="quiz-score">${percentage}%</div>
        <h3>${passed ? 'üéâ Congratulations!' : 'üìö Keep Learning!'}</h3>
        <p>You got ${correct} out of ${book.quiz.questions.length} questions correct!</p>
        ${passed ? '<button class="quiz-submit" onclick="showCertificate()">Get Your Certificate! üèÜ</button>' : 
                    '<button class="quiz-submit" onclick="closeQuiz(); setTimeout(showQuiz, 500);">Try Again</button>'}
      `;
      resultDiv.style.display = 'block';
      
      if (passed) {
        book.quizCompleted = true;
        saveProgress(bookId, percentage);
      }
    }

    function closeQuiz() {
      document.getElementById('quizModal').classList.remove('active');
    }

    // Certificate
    function showCertificate() {
      closeQuiz();
      const book = books[bookId];
      const userName = currentUser ? `${currentUser.firstName} ${currentUser.lastName}`.trim() || currentUser.email : 'Student';
      
      document.getElementById('certificateName').textContent = userName;
      document.getElementById('certificateBook').textContent = book.title;
      document.getElementById('certificateDate').textContent = new Date().toLocaleDateString();
      
      document.getElementById('certificateModal').classList.add('active');
      
      // Save certificate data
      saveCertificate(bookId, userName);
    }

    function closeCertificate() {
      document.getElementById('certificateModal').classList.remove('active');
    }

    function downloadCertificate() {
      // In a real implementation, you would use html2canvas or similar to generate an image/PDF
      alert('Certificate download feature coming soon! For now, take a screenshot of your certificate.');
    }

    // Save Progress
    function saveProgress(bookId, quizScore) {
      const progress = {
        bookId: bookId,
        completed: true,
        quizScore: quizScore,
        completedDate: new Date().toISOString(),
        timeSpent: document.getElementById('timeSpent').textContent
      };
      
      localStorage.setItem(`progress_${bookId}`, JSON.stringify(progress));
      
      // Optionally send to Google Sheets
      if (currentUser) {
        sendProgressToSheet(progress);
      }
    }

    function saveCertificate(bookId, userName) {
      const certificate = {
        bookId: bookId,
        userName: userName,
        email: currentUser ? currentUser.email : '',
        issuedDate: new Date().toISOString()
      };
      
      localStorage.setItem(`certificate_${bookId}`, JSON.stringify(certificate));
      
      // Send to Google Sheets
      if (currentUser) {
        sendCertificateToSheet(certificate);
      }
    }

    function sendProgressToSheet(progress) {
      fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'saveProgress',
          email: currentUser.email,
          ...progress
        })
      }).catch(err => console.error('Error saving progress:', err));
    }

    function sendCertificateToSheet(certificate) {
      fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'saveCertificate',
          ...certificate
        })
      }).catch(err => console.error('Error saving certificate:', err));
    }

    // Update initializeFlipbook to include enhancements
    const originalInitializeFlipbook = initializeFlipbook;
    initializeFlipbook = function() {
      const book = books[bookId];
      if (!book) {
        alert('Book not found!');
        return;
      }

      // Update book info
      document.getElementById('bookTitle').textContent = book.title;
      document.getElementById('bookAuthor').textContent = book.author;
      document.getElementById('totalPages').textContent = book.pages.length;
      document.getElementById('readingTime').textContent = (book.estimatedReadTime || 15) + ' minutes';

      // Load bookmarks
      loadBookmarks();

      // Start reading timer
      startReadingTimer();

      // Create pages with enhancements
      const flipbook = $('#flipbook');
      flipbook.empty();

      book.pages.forEach((page, index) => {
        let pageContent = '';
        
        if (page.type === 'cover') {
          pageContent = `
            <div class="page cover">
              <h1>${page.title}</h1>
              <p>${page.subtitle}</p>
              ${page.audio ? `
                <div class="audio-controls">
                  <button class="audio-btn" onclick="playAudio('${page.audio}')">üîä</button>
                </div>
              ` : ''}
            </div>
          `;
        } else if (page.type === 'back-cover') {
          pageContent = `
            <div class="page back-cover">
              <h1>${page.title}</h1>
              <p>${page.subtitle}</p>
            </div>
          `;
        } else {
          const animationClass = page.animations ? page.animations.map(a => `animate-${a}`).join(' ') : '';
          pageContent = `
            <div class="page">
              <button class="bookmark-btn ${bookmarks.includes(index + 1) ? 'bookmarked' : ''}" 
                      onclick="toggleBookmark(${index + 1}); this.classList.toggle('bookmarked');">
                ${bookmarks.includes(index + 1) ? 'üîñ' : 'üìå'}
              </button>
              ${page.image ? `<img src="${page.image}" alt="${page.title}" class="${animationClass}">` : ''}
              <h2>${page.title}</h2>
              <p>${page.text}</p>
              ${page.interactive ? `
                <div class="tap-reveal" onclick="this.classList.toggle('revealed'); 
                     this.textContent = this.classList.contains('revealed') ? '${page.interactive.revealed}' : '${page.interactive.hidden}';">
                  ${page.interactive.hidden}
                </div>
              ` : ''}
              ${page.audio ? `
                <div class="audio-controls">
                  <button class="audio-btn" onclick="playAudio('${page.audio}'); this.classList.add('playing');">‚ñ∂Ô∏è</button>
                  <button class="audio-btn" onclick="stopAudio(); document.querySelectorAll('.audio-btn').forEach(b => b.classList.remove('playing'));">‚èπÔ∏è</button>
                </div>
              ` : ''}
            </div>
          `;
        }

        flipbook.append(pageContent);
      });

      // Initialize Turn.js
      flipbook.turn({
        width: 900,
        height: 600,
        autoCenter: true,
        duration: 1000,
        gradients: true,
        acceleration: true,
        elevation: 50
      });

      // Update page indicator and progress on turn
      flipbook.bind('turned', function(event, page, view) {
        updatePageIndicator(page);
        updateProgress(page);
        stopAudio(); // Stop audio when turning page
      });

      flipbookInitialized = true;
      updatePageIndicator(1);
      updateProgress(1);
    };
  </script>
</body>
</html>
